import { useState, useRef, useCallback } from "react";
import { supabase } from "../../utils/supabase";
import quixieIcon from "../../assets/quixieIcon.svg";
import "../../Style/Liquid-glass.css";
import moment from "moment-jalaali";
import { useTaskContext } from '../../Components/TaskContext';


const AVALAI_API_KEY = process.env.REACT_APP_AVALAI_API_KEY;
const AVALAI_URL = "https://api.avalai.ir/v1/chat/completions";

const wait = (ms) => new Promise((r) => setTimeout(r, ms));

const Quixie = ({ style, userId, onBoxAdded }) => {
    const [prompt, setPrompt] = useState("");
    const [loading, setLoading] = useState(false);
    const {setCountdown, setSuccess, setError, setStatus} = useTaskContext();
    const [disabled, setDisabled] = useState(false);

    const isRequesting = useRef(false);
    const lastRequestTime = useRef(0);

    // â”€â”€â”€â”€â”€ Ù¾Ø±Ø§Ù…Ù¾Øª Ø³ÛŒØ³ØªÙ… Ø¨Ø±Ø§ÛŒ Quixie â”€â”€â”€â”€â”€
    const SYSTEM_PROMPT = `ØªÙˆ "Quixie" Ù‡Ø³ØªÛŒØŒ Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ ÙØ§Ø±Ø³ÛŒâ€ŒØ²Ø¨Ø§Ù† Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø§Ù„ÛŒ BuckBox.
ÙˆØ¸ÛŒÙÙ‡ ØªÙˆ: ØªØ­Ù„ÛŒÙ„ Ø¬Ù…Ù„Ø§Øª ÙØ§Ø±Ø³ÛŒ Ú©Ø§Ø±Ø¨Ø± Ùˆ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª "Ø¨Ø§Ú©Ø³ Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø²".

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ“… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø²Ù…Ø§Ù†ÛŒ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- Ø§Ù…Ø±ÙˆØ²: 1404/11/23 (Ø¨Ù‡Ù…Ù†)
- Ø³Ø§Ù„ Ø¬Ø§Ø±ÛŒ: 1404
- Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ: Ø¨Ù‡Ù…Ù† (Ù…Ø§Ù‡ 11)
- Ù…Ø§Ù‡â€ŒÙ‡Ø§ÛŒ 1-6: Ù‡Ø± Ú©Ø¯Ø§Ù… 31 Ø±ÙˆØ²
- Ù…Ø§Ù‡â€ŒÙ‡Ø§ÛŒ 7-11: Ù‡Ø± Ú©Ø¯Ø§Ù… 30 Ø±ÙˆØ²  
- Ù…Ø§Ù‡ 12 (Ø§Ø³ÙÙ†Ø¯): 29 Ø±ÙˆØ² (Ø¹Ø§Ø¯ÛŒ) / 30 Ø±ÙˆØ² (Ú©Ø¨ÛŒØ³Ù‡)
- Ø³Ø§Ù„ 1404 Ú©Ø¨ÛŒØ³Ù‡ Ù†ÛŒØ³Øª

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ“ Ù‚ÙˆØ§Ù†ÛŒÙ† Ø§Ø³ØªØ®Ø±Ø§Ø¬ ØªØ§Ø±ÛŒØ®
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- ÙØ±Ù…Øª Ø®Ø±ÙˆØ¬ÛŒ ØªØ§Ø±ÛŒØ®: YYYY-MM-DD Ø´Ù…Ø³ÛŒ
- "Ø¢Ø®Ø± Ø³Ø§Ù„" ÛŒØ§ "Ù¾Ø§ÛŒØ§Ù† Ø³Ø§Ù„" = 1404-12-29
- "Ø¢Ø®Ø± Ù…Ø§Ù‡" = 1404-11-30 (Ø¢Ø®Ø± Ø¨Ù‡Ù…Ù†)
- "Ø¹ÛŒØ¯ Ù†ÙˆØ±ÙˆØ²" = 1405-01-01
- "X Ù…Ø§Ù‡ Ø¯ÛŒÚ¯Ù‡" = Ø§Ø² Ø§Ù…Ø±ÙˆØ² X Ù…Ø§Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
  Ù…Ø«Ø§Ù„: "Ø³Ù‡ Ù…Ø§Ù‡ Ø¯ÛŒÚ¯Ù‡" = 1405-02-23
  Ù…Ø«Ø§Ù„: "Ø´Ø´ Ù…Ø§Ù‡ Ø¯ÛŒÚ¯Ù‡" = 1405-05-23
- "X Ù‡ÙØªÙ‡ Ø¯ÛŒÚ¯Ù‡" = Ø§Ø² Ø§Ù…Ø±ÙˆØ² X*7 Ø±ÙˆØ² Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
- "ØªØ§Ø¨Ø³ØªÙˆÙ†" = 1405-04-01
- "Ø§ÙˆÙ„ Ø¨Ù‡Ø§Ø±" = 1405-01-01
- "ÛŒÙ„Ø¯Ø§" = 1404-09-30
- "Ù†ÛŒÙ…Ù‡ Ø´Ø¹Ø¨Ø§Ù†" = ØªØ§Ø±ÛŒØ® ØªÙ‚Ø±ÛŒØ¨ÛŒ Ø¨Ø¯Ù‡
- Ø§Ú¯Ù‡ ØªØ§Ø±ÛŒØ® Ù…Ø´Ø®Øµ Ù†ÛŒØ³Øª = 3 Ù…Ø§Ù‡ Ø¨Ø¹Ø¯ Ø§Ø² Ø§Ù…Ø±ÙˆØ² (1405-02-23)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ’° Ù‚ÙˆØ§Ù†ÛŒÙ† Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¨Ù„Øº
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- Ø®Ø±ÙˆØ¬ÛŒ: ÙÙ‚Ø· Ø¹Ø¯Ø¯ ØµØ­ÛŒØ­ (integer) Ø¨Ø¯ÙˆÙ† Ú©Ø§Ù…Ø§ØŒ Ù†Ù‚Ø·Ù‡ ÛŒØ§ Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡
- "Ù…ÛŒÙ„ÛŒÙˆÙ†" = Ã—1,000,000
  "Ûµ Ù…ÛŒÙ„ÛŒÙˆÙ†" = 5000000
  "ÛµÛ° Ù…ÛŒÙ„ÛŒÙˆÙ†" = 50000000
  "ÛŒÚ© Ùˆ Ù†ÛŒÙ… Ù…ÛŒÙ„ÛŒÙˆÙ†" = 1500000
  "Ø¯Ùˆ Ùˆ Ù†ÛŒÙ… Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯" = 2500000000
- "Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯" = Ã—1,000,000,000
- "Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù†" ÛŒØ§ "Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ù†" = Ã—1,000
  "ÛµÛ°Û° ØªÙˆÙ…Ù†" = 500
  "ÛµÛ°Û° Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ù†" = 500000
- "ØªÙˆÙ…Ø§Ù†" Ùˆ "ØªÙˆÙ…Ù†" ÛŒÚ©ÛŒ Ù‡Ø³ØªÙ†Ø¯
- Ø§Ø¹Ø¯Ø§Ø¯ ÙØ§Ø±Ø³ÛŒ (Û±Û²Û³) Ùˆ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ (123) Ù‡Ø± Ø¯Ùˆ Ù‚Ø¨ÙˆÙ„ Ù‡Ø³ØªÙ†Ø¯
- Ø§Ú¯Ù‡ Ù…Ø¨Ù„Øº Ù…Ø´Ø®Øµ Ù†ÛŒØ³Øª = 1000000 (ÛŒÚ© Ù…ÛŒÙ„ÛŒÙˆÙ† Ù¾ÛŒØ´â€ŒÙØ±Ø¶)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ“ Ù‚ÙˆØ§Ù†ÛŒÙ† Ù†Ø§Ù…â€ŒÚ¯Ø°Ø§Ø±ÛŒ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- Ù†Ø§Ù… Ø¨Ø§Ú©Ø³ Ø¨Ø§ÛŒØ¯ Ú©ÙˆØªØ§Ù‡ Ùˆ ÙˆØ§Ø¶Ø­ Ø¨Ø§Ø´Ø¯ (Ø­Ø¯Ø§Ú©Ø«Ø± 4 Ú©Ù„Ù…Ù‡)
- Ø§Ø² Ø®ÙˆØ¯ Ø¬Ù…Ù„Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ú©Ù†
  "Ù…ÛŒØ®ÙˆØ§Ù… Ø¨Ø±Ø§ÛŒ Ù…Ø§Ø´ÛŒÙ† Ù¾ÙˆÙ„ Ø¬Ù…Ø¹ Ú©Ù†Ù…" â†’ name: "Ù…Ø§Ø´ÛŒÙ†"
  "Ù…ÛŒØ®ÙˆØ§Ù… Ø¢ÛŒÙÙˆÙ† Ø¨Ø®Ø±Ù…" â†’ name: "Ø¢ÛŒÙÙˆÙ†"
  "Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø² Ø¹Ø±ÙˆØ³ÛŒ" â†’ name: "Ø¹Ø±ÙˆØ³ÛŒ"
  "Ø¨Ø±Ø§ÛŒ Ø³ÙØ± ØªØ±Ú©ÛŒÙ‡" â†’ name: "Ø³ÙØ± ØªØ±Ú©ÛŒÙ‡"
- Ø§Ú¯Ù‡ Ù†Ø§Ù… Ù…Ø´Ø®Øµ Ù†ÛŒØ³Øª = "Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø² Ù…Ù†"

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ“ Ù‚ÙˆØ§Ù†ÛŒÙ† ØªÙˆØ¶ÛŒØ­Ø§Øª
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- ØªÙˆØ¶ÛŒØ­Ø§Øª: ÛŒÚ© Ø¬Ù…Ù„Ù‡ Ú©ÙˆØªØ§Ù‡ ÙØ§Ø±Ø³ÛŒ Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù‡Ø¯Ù Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø²
- Ø­Ø¯Ø§Ú©Ø«Ø± 50 Ú©Ø§Ø±Ø§Ú©ØªØ±
- Ù…Ø«Ø§Ù„: "Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø² Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ Ù…Ø§Ø´ÛŒÙ† Ù¾Ø±Ø§ÛŒØ¯"
- Ø§Ú¯Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§ÙÛŒ Ù†ÛŒØ³ØªØŒ Ø®ÙˆØ¯Øª ÛŒÙ‡ ØªÙˆØ¶ÛŒØ­ Ù…Ù†Ø·Ù‚ÛŒ Ø¨Ø³Ø§Ø²

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸš« Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- ÙÙ‚Ø· JSON Ø®Ø§Ù„Øµ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†ØŒ Ø¨Ø¯ÙˆÙ† Ù‡ÛŒÚ† Ù…ØªÙ† Ø§Ø¶Ø§ÙÙ‡
- Ø¨Ø¯ÙˆÙ† markdownØŒ Ø¨Ø¯ÙˆÙ† Ø¨Ú©â€ŒØªÛŒÚ©ØŒ Ø¨Ø¯ÙˆÙ† ØªÙˆØ¶ÛŒØ­
- Ø§Ú¯Ù‡ Ø¬Ù…Ù„Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø±Ø¨Ø·ÛŒ Ø¨Ù‡ Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø² Ù†Ø¯Ø§Ø±Ù‡ØŒ Ø¨Ø§Ø² Ù‡Ù… Ø³Ø¹ÛŒ Ú©Ù† Ø¨ÙÙ‡Ù…ÛŒ Ù…Ù†Ø¸ÙˆØ±Ø´ Ú†ÛŒÙ‡
- Ù‡ÛŒÚ†ÙˆÙ‚Øª null ÛŒØ§ undefined Ø¨Ø±Ù†Ú¯Ø±Ø¯Ø§Ù†
- requiredValue Ù‡Ù…ÛŒØ´Ù‡ Ø¹Ø¯Ø¯ ØµØ­ÛŒØ­ Ù…Ø«Ø¨Øª Ø¨Ø§Ø´Ù‡

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ’¡ Ù…Ø«Ø§Ù„â€ŒÙ‡Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒ/Ø®Ø±ÙˆØ¬ÛŒ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ÙˆØ±ÙˆØ¯ÛŒ: "Ø¨Ø§Ú©Ø³ Ù…Ø§Ø´ÛŒÙ† ÛµÛ° Ù…ÛŒÙ„ÛŒÙˆÙ† ØªØ§ Ø¢Ø®Ø± Ø³Ø§Ù„"
Ø®Ø±ÙˆØ¬ÛŒ: {"name":"Ù…Ø§Ø´ÛŒÙ†","description":"Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø² Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ Ù…Ø§Ø´ÛŒÙ†","date":"1404-12-29","requiredValue":50000000}

ÙˆØ±ÙˆØ¯ÛŒ: "Ù…ÛŒØ®ÙˆØ§Ù… Ø¨Ø±Ø§ÛŒ Ø³ÙØ± ØªØ±Ú©ÛŒÙ‡ Û²Û° Ù…ÛŒÙ„ÛŒÙˆÙ† ØªØ§ ØªØ§Ø¨Ø³ØªÙˆÙ† Ø¬Ù…Ø¹ Ú©Ù†Ù…"
Ø®Ø±ÙˆØ¬ÛŒ: {"name":"Ø³ÙØ± ØªØ±Ú©ÛŒÙ‡","description":"Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø² Ø¨Ø±Ø§ÛŒ Ø³ÙØ± ØªØ§Ø¨Ø³ØªØ§Ù†ÛŒ ØªØ±Ú©ÛŒÙ‡","date":"1405-04-01","requiredValue":20000000}

ÙˆØ±ÙˆØ¯ÛŒ: "Ù„Ù¾ØªØ§Ù¾ Û±Ûµ Ù…ÛŒÙ„ÛŒÙˆÙ† Ø³Ù‡ Ù…Ø§Ù‡ Ø¯ÛŒÚ¯Ù‡"
Ø®Ø±ÙˆØ¬ÛŒ: {"name":"Ù„Ù¾ØªØ§Ù¾","description":"Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø² Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ Ù„Ù¾ØªØ§Ù¾","date":"1405-02-23","requiredValue":15000000}

ÙˆØ±ÙˆØ¯ÛŒ: "Ù…ÛŒØ®ÙˆØ§Ù… ÛµÛ°Û° ØªÙˆÙ…Ù† Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø² Ú©Ù†Ù…"
Ø®Ø±ÙˆØ¬ÛŒ: {"name":"Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø² Ù…Ù†","description":"Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø² Ø´Ø®ØµÛŒ","date":"1405-02-23","requiredValue":500}

ÙˆØ±ÙˆØ¯ÛŒ: "Ø¹Ø±ÙˆØ³ÛŒ Ø¯Ùˆ Ùˆ Ù†ÛŒÙ… Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯ Ø¢Ø®Ø± Ø¨Ù‡Ø§Ø±"
Ø®Ø±ÙˆØ¬ÛŒ: {"name":"Ø¹Ø±ÙˆØ³ÛŒ","description":"Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø² Ø¨Ø±Ø§ÛŒ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø¹Ø±ÙˆØ³ÛŒ","date":"1405-03-31","requiredValue":2500000000}

ÙˆØ±ÙˆØ¯ÛŒ: "Ø¢ÛŒÙÙˆÙ† Û±Û¶ Ù¾Ø±Ùˆ Ù…Ú©Ø³"
Ø®Ø±ÙˆØ¬ÛŒ: {"name":"Ø¢ÛŒÙÙˆÙ† Û±Û¶ Ù¾Ø±Ùˆ Ù…Ú©Ø³","description":"Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø² Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ Ø¢ÛŒÙÙˆÙ† Û±Û¶ Ù¾Ø±Ùˆ Ù…Ú©Ø³","date":"1405-02-23","requiredValue":80000000}

ÙˆØ±ÙˆØ¯ÛŒ: "ps5"
Ø®Ø±ÙˆØ¬ÛŒ: {"name":"PS5","description":"Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø² Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ Ù¾Ù„ÛŒâ€ŒØ§Ø³ØªÛŒØ´Ù† Ûµ","date":"1405-02-23","requiredValue":30000000}

ÙˆØ±ÙˆØ¯ÛŒ: "Ù‡Ø¯ÛŒÙ‡ ØªÙˆÙ„Ø¯ Ù…Ø§Ù…Ø§Ù† Ù‡ÙØªÙ‡ Ø¯ÛŒÚ¯Ù‡ Û² Ù…ÛŒÙ„ÛŒÙˆÙ†"
Ø®Ø±ÙˆØ¬ÛŒ: {"name":"Ù‡Ø¯ÛŒÙ‡ ØªÙˆÙ„Ø¯ Ù…Ø§Ù…Ø§Ù†","description":"Ø®Ø±ÛŒØ¯ Ù‡Ø¯ÛŒÙ‡ ØªÙˆÙ„Ø¯ Ø¨Ø±Ø§ÛŒ Ù…Ø§Ø¯Ø±","date":"1404-11-30","requiredValue":2000000}`;


    // ØªÙˆÛŒ SYSTEM_PROMPT Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†:
    const today = moment().format("jYYYY/jMM/jDD");
    const currentMonth = moment().jMonth() + 1; // 1-12
    const currentYear = moment().jYear();

    const DYNAMIC_PROMPT = SYSTEM_PROMPT
        .replace("1404/11/23", today)
        .replace("Ø³Ø§Ù„ Ø¬Ø§Ø±ÛŒ: 1404", `Ø³Ø§Ù„ Ø¬Ø§Ø±ÛŒ: ${currentYear}`)
        .replace("Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ: Ø¨Ù‡Ù…Ù† (Ù…Ø§Ù‡ 11)", `Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ: Ù…Ø§Ù‡ ${currentMonth}`);

    // â”€â”€â”€â”€â”€ Ø´Ù…Ø§Ø±Ø´ Ù…Ø¹Ú©ÙˆØ³ â”€â”€â”€â”€â”€
    const startCountdown = useCallback(async (seconds) => {
        for (let s = seconds; s > 0; s--) {
            setCountdown(s);
            await wait(1000);
        }
        setCountdown(0);
    }, []);

    // â”€â”€â”€â”€â”€ Ø§Ø±Ø³Ø§Ù„ Ø¨Ø§ retry â”€â”€â”€â”€â”€
    const callAvalAI = async (messages) => {

        const MAX_RETRIES = 3;

        for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {
            setStatus(`ðŸ“¡ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª... (ØªÙ„Ø§Ø´ ${attempt}/${MAX_RETRIES})`);

            const res = await fetch(AVALAI_URL, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${AVALAI_API_KEY}`,
                },
                body: JSON.stringify({
                    model: "gemini-2.0-flash-lite",
                    messages: messages,
                    temperature: 0.2,
                    max_tokens: 500,
                    response_format: {
                        type: "json_schema",
                        json_schema: {
                            name: "saving_box",
                            strict: true,
                            schema: {
                                type: "object",
                                properties: {
                                    name: { type: "string", description: "Ù†Ø§Ù… Ø¨Ø§Ú©Ø³ Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø²" },
                                    description: { type: "string", description: "ØªÙˆØ¶ÛŒØ­Ø§Øª Ø¨Ø§Ú©Ø³" },
                                    date: {
                                        type: "string",
                                        description: "ØªØ§Ø±ÛŒØ® Ù‡Ø¯Ù YYYY-MM-DD Ø´Ù…Ø³ÛŒ",
                                    },
                                    requiredValue: {
                                        type: "number",
                                        description: "Ù…Ø¨Ù„Øº Ù‡Ø¯Ù Ø¨Ù‡ ØªÙˆÙ…Ø§Ù†",
                                    },
                                },
                                required: ["name", "description", "date", "requiredValue"],
                                additionalProperties: false,
                            },
                        },
                    },
                }),
            });

            if (res.ok) {
                setStatus("âœ… Ù¾Ø§Ø³Ø® Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯!");
                // âœ… Ø§ÛŒÙ†Ø¬Ø§ JSON Ø±Ùˆ Ù…ÛŒØ®ÙˆÙ†ÛŒÙ… Ùˆ Ø¨Ø±Ù…ÛŒÚ¯Ø±Ø¯ÙˆÙ†ÛŒÙ…
                const data = await res.json();
                return data;
            }

            if (res.status === 429) {
                const waitSec = attempt * 15;
                setStatus(`â³ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ù†Ø±Ø®. ${waitSec} Ø«Ø§Ù†ÛŒÙ‡ ØµØ¨Ø±...`);
                await startCountdown(waitSec);
                setStatus("");
                continue;
            }

            // âŒ Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø¯ÛŒÚ¯Ù‡
            const errBody = await res.json().catch(() => ({}));
            throw new Error(errBody.error?.message || `Ø®Ø·Ø§: ${res.status}`);
        }

        throw new Error("Ø¨Ø¹Ø¯ Ø§Ø² Û³ ØªÙ„Ø§Ø´ Ø¬ÙˆØ§Ø¨ Ù†Ú¯Ø±ÙØªÛŒÙ…. Ú©Ù…ÛŒ ØµØ¨Ø± Ú©Ù†ÛŒØ¯.");
    };

    // â”€â”€â”€â”€â”€ ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ â”€â”€â”€â”€â”€
    const handleSubmit = async () => {
        if (!prompt.trim() || isRequesting.current || disabled) return;

        const now = Date.now();
        if (now - lastRequestTime.current < 3000) {
            setError("â³ Ø¨ÛŒÙ† Ù‡Ø± Ø¯Ø±Ø®ÙˆØ§Ø³Øª Û³ Ø«Ø§Ù†ÛŒÙ‡ ØµØ¨Ø± Ú©Ù†ÛŒØ¯.");
            return;
        }

        isRequesting.current = true;
        lastRequestTime.current = Date.now();
        setLoading(true);
        setError("");
        setSuccess("");
        setStatus("ðŸ§  Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...");

        try {
            const messages = [
                {
                    role: "system",
                    content: DYNAMIC_PROMPT,
                },
                {
                    role: "user",
                    content: prompt,
                },
            ];

            // âœ… Ø­Ø§Ù„Ø§ data Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ø±Ù…ÛŒÚ¯Ø±Ø¯Ù‡ (Ù†Ù‡ Response)
            const data = await callAvalAI(messages);

            // â”€â”€â”€â”€â”€ Ø§Ø³ØªØ®Ø±Ø§Ø¬ JSON â”€â”€â”€â”€â”€
            let text = data.choices?.[0]?.message?.content;
            if (!text) throw new Error("Ù¾Ø§Ø³Ø® Ø®Ø§Ù„ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯");

            let boxData;
            try {
                boxData = JSON.parse(text);
            } catch {
                // Ø§Ú¯Ù‡ JSON Ø®Ø§Ù„Øµ Ù†Ø¨ÙˆØ¯ØŒ Ø¨Ø§ regex Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ú©Ù†
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (!jsonMatch)
                    throw new Error("ÙØ±Ù…Øª Ù¾Ø§Ø³Ø® Ù†Ø§Ù…Ø¹ØªØ¨Ø±. Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.");
                boxData = JSON.parse(jsonMatch[0]);
            }

            // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ
            if (!boxData.name) throw new Error("Ù†Ø§Ù… Ø¨Ø§Ú©Ø³ ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯.");
            if (!boxData.requiredValue || isNaN(boxData.requiredValue)) {
                throw new Error("Ù…Ø¨Ù„Øº Ù‡Ø¯Ù ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯.");
            }
            if (!boxData.date) throw new Error("ØªØ§Ø±ÛŒØ® Ù‡Ø¯Ù ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯.");

            // â”€â”€â”€â”€â”€ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Supabase â”€â”€â”€â”€â”€
            setStatus("ðŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³...");
            const { error: dbErr } = await supabase.from("BuckBoxs").insert({
                name: boxData.name,
                description: boxData.description || "",
                date: boxData.date,
                requiredValue: Number(boxData.requiredValue),
                user_id: userId,
            });

            if (dbErr) throw new Error(dbErr.message);

            setSuccess(
                `âœ… Ø¨Ø§Ú©Ø³ "${boxData.name}" â€” ${Number(
                    boxData.requiredValue
                ).toLocaleString()} ØªÙˆÙ…Ø§Ù† â€” ØªØ§ ${boxData.date} Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯!`
            );
            setPrompt("");
            setStatus("");
            if (onBoxAdded) onBoxAdded();

            setDisabled(true);
            setTimeout(() => setDisabled(false), 3000);
        } catch (err) {
            setError(err.message);
            setStatus("");
        } finally {
            setLoading(false);
            isRequesting.current = false;
        }
    };

    // â”€â”€â”€â”€â”€ UI â”€â”€â”€â”€â”€

    return (
        <div className="quixie notEffect" style={style}>
            <svg xmlns="http://www.w3.org/2000/svg" style={{ display: "none" }}>
                <defs><filter id="glass-distortion" x="0%" y="0%" width="100%" height="100%">
                    <feTurbulence type="fractalNoise" baseFrequency="0.015 0.015" numOctaves="2" seed="92" result="noise" />
                    <feGaussianBlur in="noise" stdDeviation="2" result="blurred" />
                    <feDisplacementMap in="SourceGraphic" in2="blurred" scale="200" xChannelSelector="R" yChannelSelector="G" />
                </filter></defs></svg>
            <div className="input-wrapper">
                <img className="icon" src={quixieIcon}></img>
                <input type="text" name="text" className="input" placeholder="Ø¨Ø³Ù¾Ø§Ø±Ø´ Ø¨Ù‡ Quixie." disabled={loading} onChange={(e) => setPrompt(e.target.value)} onKeyDown={(e) => e.key === "Enter" && handleSubmit()} value={prompt} />
                <button className="Subscribe-btn" onClick={handleSubmit} disabled={loading || !prompt.trim()}>
                    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="10" viewBox="0 0 38 15" className="arrow"><path d="M10 7.519l-.939-.344h0l.939.344zm14.386-1.205l-.981-.192.981.192zm1.276 5.509l.537.843.148-.094.107-.139-.792-.611zm4.819-4.304l-.385-.923h0l.385.923zm7.227.707a1 1 0 0 0 0-1.414L31.343.448a1 1 0 0 0-1.414 0 1 1 0 0 0 0 1.414l5.657 5.657-5.657 5.657a1 1 0 0 0 1.414 1.414l6.364-6.364zM1 7.519l.554.833.029-.019.094-.061.361-.23 1.277-.77c1.054-.609 2.397-1.32 3.629-1.787.617-.234 1.17-.392 1.623-.455.477-.066.707-.008.788.034.025.013.031.021.039.034a.56.56 0 0 1 .058.235c.029.327-.047.906-.39 1.842l1.878.689c.383-1.044.571-1.949.505-2.705-.072-.815-.45-1.493-1.16-1.865-.627-.329-1.358-.332-1.993-.244-.659.092-1.367.305-2.056.566-1.381.523-2.833 1.297-3.921 1.925l-1.341.808-.385.245-.104.068-.028.018c-.011.007-.011.007.543.84zm8.061-.344c-.198.54-.328 1.038-.36 1.484-.032.441.024.94.325 1.364.319.45.786.64 1.21.697.403.054.824-.001 1.21-.09.775-.179 1.694-.566 2.633-1.014l3.023-1.554c2.115-1.122 4.107-2.168 5.476-2.524.329-.086.573-.117.742-.115s.195.038.161.014c-.15-.105.085-.139-.076.685l1.963.384c.192-.98.152-2.083-.74-2.707-.405-.283-.868-.37-1.28-.376s-.849.069-1.274.179c-1.65.43-3.888 1.621-5.909 2.693l-2.948 1.517c-.92.439-1.673.743-2.221.87-.276.064-.429.065-.492.057-.043-.006.066.003.155.127.07.099.024.131.038-.063.014-.187.078-.49.243-.94l-1.878-.689zm14.343-1.053c-.361 1.844-.474 3.185-.413 4.161.059.95.294 1.72.811 2.215.567.544 1.242.546 1.664.459a2.34 2.34 0 0 0 .502-.167l.15-.076.049-.028.018-.011c.013-.008.013-.008-.524-.852l-.536-.844.019-.012c-.038.018-.064.027-.084.032-.037.008.053-.013.125.056.021.02-.151-.135-.198-.895-.046-.734.034-1.887.38-3.652l-1.963-.384zm2.257 5.701l.791.611.024-.031.08-.101.311-.377 1.093-1.213c.922-.954 2.005-1.894 2.904-2.27l-.771-1.846c-1.31.547-2.637 1.758-3.572 2.725l-1.184 1.314-.341.414-.093.117-.025.032c-.01.013-.01.013.781.624zm5.204-3.381c.989-.413 1.791-.42 2.697-.307.871.108 2.083.385 3.437.385v-2c-1.197 0-2.041-.226-3.19-.369-1.114-.139-2.297-.146-3.715.447l.771 1.846z"></path></svg>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 16 16"><path fill="currentColor" d="m7.187 13.528l-.034.056a.2.2 0 0 1-.306 0l-.034-.056l-.069-.175l.256.101l.255-.1zM6.813 2.472a.2.2 0 0 1 .374 0L8.219 5.09a3 3 0 0 0 1.69 1.69l2.444.963l.101.256l-.1.255l-2.445.964l-.143.06a3 3 0 0 0-1.547 1.63l-.964 2.444l-.255.101l-.256-.1l-.963-2.445a3 3 0 0 0-1.547-1.63l-.143-.06l-2.62-1.032a.2.2 0 0 1 0-.374l.175-.069l2.445-.963a3 3 0 0 0 1.63-1.547l.06-.143zm-.102 2.986A4 4 0 0 1 4.648 7.63l-.19.08l-.733.29l.733.289a4 4 0 0 1 2.253 2.253l.289.732l.29-.732a4 4 0 0 1 2.252-2.253L10.274 8l-.732-.29A4 4 0 0 1 7.37 5.649l-.08-.19L7 4.725zm5.817 2.355a.2.2 0 0 1 0 .374l-.175.068l.101-.255l-.1-.256zm-.165-4.947c.224.401.579.716 1.011.887l.39.154a.1.1 0 0 1 0 .186l-.087.034l-.303.12l-.188.086a2 2 0 0 0-.939 1.041l-.12.303l-.034.087l-.016.028a.1.1 0 0 1-.154 0l-.016-.028l-.035-.087l-.12-.303a2 2 0 0 0-.937-1.041l-.189-.086l-.39-.154a.1.1 0 0 1 0-.186l.086-.035l.304-.12c.432-.17.786-.485 1.01-.886L12 2.723zm-.456-.63a.1.1 0 0 1 .186 0l.154.39q.05.124.116.24L12 2.723l-.364.143l.031-.052l.086-.188zm.519 6.951a.08.08 0 0 1 .148 0a3.97 3.97 0 0 0 2.239 2.239a.08.08 0 0 1 0 .148l-.07.03a3.97 3.97 0 0 0-2.169 2.209l-.012.022a.08.08 0 0 1-.123 0l-.013-.023a3.97 3.97 0 0 0-2.049-2.158l-.19-.08a.08.08 0 0 1 0-.148a3.97 3.97 0 0 0 2.239-2.239m.074 1.784q-.245.285-.53.529q.285.245.53.528q.245-.284.528-.528a5 5 0 0 1-.528-.53" /></svg>
                </button>
            </div>
        </div>
    )
};

export default Quixie;